基于 **Spring Security + JWT双token + Redis + JPA** 的认证授权模块

认证就是**确认用户的真实身份** ，**授权是指用户允许第三方应用访问其特定资源的权限**

（1）同一账户不限制登录数量

（2）RABC:现在就是两个角色，用户，超级管理员

Spring Security

Spring Security 中角色名默认前缀是 `ROLE_`，所以你的角色必须是 `ROLE_USER` 而不是 `USER`，否则权限判断会失败。

jwt+redis 认证最核心部分是 **校验签名和过期时间**，这是本地计算，**不依赖 Redis** ，redis ression 认证强依赖redis

如果 Redis 无法访问：

* 可以设计成“**容忍失败，默认放行或降级处理**”   (try-catch,降级实现，简单来说就是：**当 Redis 不可用或响应异常时，不让整个认证流程失败，而是捕获异常，跳过 Redis 相关校验，保证系统可用性。**)
* 比如，无法查到黑名单时，假设 token 未被吊销（保守策略）
* 权限缓存不可用时，改从数据库实时查权限


| 组件                | 所在阶段 / 位置             | 核心职责                                                                                                                          | 补充说明                                                                                                                | 中文官网 / 官方地址                                                       |
| ------------------- | --------------------------- | --------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------- |
| **Spring Security** | 请求前（过滤器链）          | - 拦截所有 HTTP 请求<br/>- 提取请求头中的 JWT Token<br/>- 执行自定义认证逻辑（如 JWT 校验）<br/>- 基于权限执行访问控制            | 相当于“守门员”，构建了整个安全框架的骨架，是权限体系的基础                                                            | [Spring Security 中文网](https://springdoc.cn/spring-security/index.html) |
| **JWT**             | 请求头携带（Authorization） | - 携带用户身份（如 userId, roles）<br/>- 服务端验证签名、防篡改、过期时间<br/>- 验证通过后解析生成 Authentication 对象            | 用于身份认证的令牌机制，客户端请求中携带，服务端通过解析 JWT<br />实现“无状态”认证,减少服务端会话压力，适合分布式系统 |                                                                           |
| **Redis**           | 后端缓存 / 状态服务         | - 存储黑名单 Token（实现 Token 吊销）<br/>- 存储 Refresh Token（实现 Token 刷新）<br/>- 缓存用户信息与权限<br/>- 记录在线用户列表 | 为 JWT 提供“状态增强”，解决 JWT 无法主动失效的问题                                                                    | [Redis 中文网教程](https://www.redis.net.cn/tutorial/3501.html)           |

领域事件：

## 用户操作行为与使用场景对照表（适用于认证授权系统）


| 编号    | 用户行为 / 动作                  | 使用场景说明                                                                                                      |
| ------- | -------------------------------- | ----------------------------------------------------------------------------------------------------------------- |
| 1/v2/v3 | **登录**                         | 用户通过账号+密码、邮箱验证码(v2)或手机验证码(v3)登录系统，获取 Access Token 和 Refresh Token，用于后续身份验证。 |
| 2/v2    | **注册（含密码复杂度校验）**     | 首次使用系统时创建账号，通常需邮箱验证码/手机短信验证，创建成功后可直接登录或跳转登录流程。                       |
| 3       | **用户主动登出**                 | 用户在当前设备上点击“退出登录”，清除本地 Token，同时服务端标记该 Token 为无效（如加入黑名单）。                 |
| 4       | **全局登出（退出所有设备）**     | 用户触发“退出所有设备”，清除所有设备上的 Token（可通过清除 Redis 记录实现），常用于账号被盗或安全策略要求。     |
| 5       | **密码修改**                     | 用户已知当前密码，主动修改为新密码，常用于安全习惯或防止他人登录；修改后建议执行全局登出。                        |
| 6       | **密码重置验证（忘记密码）**     | 用户忘记密码，需通过手机/邮箱验证码验证身份后设置新密码。用于恢复账号访问权限。                                   |
| v2      | **绑定手机 / 更换手机号**        | 用于增强账号安全性、接收验证码、辅助找回密码等功能；更换手机号时需验证旧手机号或登录密码。                        |
| 7       | **绑定邮箱 / 更换邮箱**          | 提高账号可恢复性和安全性，邮箱也可用于接收验证码、验证身份、通知提醒等。                                          |
| v2      | **用户信息更新**（如昵称、头像） | 用户修改个人资料，如昵称、头像、性别、地址、个性签名等，常见于“个人中心”模块。                                  |
| 8       | **令牌刷新（Refresh Token）**    | 当 Access Token 过期但 Refresh Token 仍有效时，客户端可无感知地请求新 Access Token，避免频繁重新登录。            |
| 9       | **令牌吊销（Token Revoke）**     | 用户登出、全局登出、管理员强制下线或账号被封禁等场景下，立即使 Token 失效，防止继续访问受保护资源。               |

（v3）

管理员可以做的事情：账号冻结,记录在线用户,设置黑名单，用户活跃度监控

登录（v3有10次登录失败限制，v4后续第三方登录）

后续权限扩展

# 网络安全：


| 安全类型                 | 定义 / 攻击方式描述                          | 避免方式 / 防御手段                                                          |
| ------------------------ | -------------------------------------------- | ---------------------------------------------------------------------------- |
| **CSRF（跨站请求伪造）** | 利用用户已登录状态，诱导向原网站发送恶意请求 | JWT 存放在`localStorage`（不会被自动发送）                                   |
| **XSS（跨站脚本攻击）**  | 注入并执行恶意脚本，窃取数据或控制用户行为   | 创建 XSS 过滤器：对输入做校验、输出做转义<br />使用内容安全策略（CSP）(v4)   |
| **SQL 注入**             | 构造恶意 SQL 语句获取、篡改数据库数据        | 使用预编译语句（PreparedStatement）<br />输入校验                            |
| **中间人攻击（MITM）**   | 拦截或篡改客户端与服务端之间的数据传输       | 使用 HTTPS（SSL/TLS）加密通信(v4)                                            |
| **JWT 使用规范**         | 认证令牌的推荐使用方式                       | ✅ 将 JWT 放入`Authorization`请求头中（如：`Authorization: Bearer <token>`） |

# 数据安全

数据脱敏 Hutool
